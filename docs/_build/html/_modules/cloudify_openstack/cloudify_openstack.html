

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cloudify_openstack.cloudify_openstack &mdash; cloudify-openstack-provider 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="cloudify-openstack-provider 1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> cloudify-openstack-provider</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="simple">
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">cloudify-openstack-provider</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>cloudify_openstack.cloudify_openstack</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for cloudify_openstack.cloudify_openstack</h1><div class="highlight"><pre>
<span class="c">########</span>
<span class="c"># Copyright (c) 2014 GigaSpaces Technologies Ltd. All rights reserved</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#        http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>
<span class="c">############</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;ran&#39;</span>

<span class="c"># Standard</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">stat</span> <span class="kn">import</span> <span class="n">ST_MODE</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getuser</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">expanduser</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">put</span><span class="p">,</span> <span class="n">env</span>
<span class="kn">from</span> <span class="nn">fabric.context_managers</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">platform</span>

<span class="c"># Validator</span>
<span class="kn">from</span> <span class="nn">IPy</span> <span class="kn">import</span> <span class="n">IP</span>
<span class="kn">from</span> <span class="nn">schemas</span> <span class="kn">import</span> <span class="n">PROVIDER_CONFIG_SCHEMA</span>

<span class="c"># OpenStack</span>
<span class="kn">import</span> <span class="nn">keystoneclient.v2_0.client</span> <span class="kn">as</span> <span class="nn">keystone_client</span>
<span class="kn">import</span> <span class="nn">novaclient.v1_1.client</span> <span class="kn">as</span> <span class="nn">nova_client</span>
<span class="kn">import</span> <span class="nn">neutronclient.neutron.client</span> <span class="kn">as</span> <span class="nn">neutron_client</span>

<span class="c"># from CLI</span>
<span class="c"># provides a logger to be used throughout the provider code</span>
<span class="c"># returns a tuple of a main (file+console logger) and a file</span>
<span class="c"># (file only) logger.</span>
<span class="kn">from</span> <span class="nn">cosmo_cli.cosmo_cli</span> <span class="kn">import</span> <span class="n">init_logger</span>
<span class="c"># provides a way to set the global verbosity level</span>
<span class="c"># from cosmo_cli.cosmo_cli import set_global_verbosity_level</span>
<span class="c"># provides 2 base methods to be used.</span>
<span class="c"># if not imported, the bootstrap method must be implemented</span>
<span class="kn">from</span> <span class="nn">cosmo_cli.provider_common</span> <span class="kn">import</span> <span class="n">BaseProviderClass</span>

<span class="c"># declare the create_if_missing flag</span>
<span class="n">CREATE_IF_MISSING</span> <span class="o">=</span> <span class="s">&#39;create_if_missing&#39;</span>
<span class="c"># declare which ssh key permissions are valid for bootstrap</span>
<span class="n">MINIMAL_KEY_PERMS</span> <span class="o">=</span> <span class="mi">600</span>

<span class="c"># declare which ports should be opened during provisioning</span>
<span class="n">EXTERNAL_MGMT_PORTS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">8100</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>  <span class="c"># SSH, REST service (TEMP), REST and UI</span>
<span class="n">INTERNAL_MGMT_PORTS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5555</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="mi">53229</span><span class="p">)</span>  <span class="c"># Riemann, RabbitMQ, FileServer</span>
<span class="n">INTERNAL_AGENT_PORTS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">22</span><span class="p">,)</span>

<span class="c"># declare default verbosity state</span>
<span class="n">verbose_output</span> <span class="o">=</span> <span class="bp">False</span>
<span class="c"># declare os types for validation checks</span>
<span class="n">linuxd</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Linux&#39;</span><span class="p">)</span>
<span class="n">wind</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Windows&#39;</span><span class="p">)</span>

<span class="c"># initialize logger</span>
<span class="n">lgr</span><span class="p">,</span> <span class="n">flgr</span> <span class="o">=</span> <span class="n">init_logger</span><span class="p">()</span>


<div class="viewcode-block" id="ProviderManager"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.ProviderManager">[docs]</a><span class="k">class</span> <span class="nc">ProviderManager</span><span class="p">(</span><span class="n">BaseProviderClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;class for base methods name must be kept as is.</span>

<span class="sd">    inherits BaseProviderClass from the cli containing the following</span>
<span class="sd">    methods:</span>

<span class="sd">    __init__: initializes base mandatory params provider_config and</span>
<span class="sd">    is_verbose_output. additionally, optionally receives a schema param</span>
<span class="sd">    that enables the default schema validation method to be executed.</span>

<span class="sd">    bootstrap: installs cloudify on the management server.</span>

<span class="sd">    validate_config_schema: validates a schema file against the provider</span>
<span class="sd">    configuration file supplied with the provider module.</span>
<span class="sd">    (for more info on BaseProviderClass, see the CLI&#39;s documentation.)</span>

<span class="sd">    ProviderManager classes:</span>

<span class="sd">    - __init__: *optional* - only if more params are initialized</span>
<span class="sd">    - provision: *mandatory*</span>
<span class="sd">    - validate: *mandatory*</span>
<span class="sd">    - teardown: *mandatory*</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initializes base params.</span>

<span class="sd">        provider_config and is_verbose_output are initialized in the</span>
<span class="sd">        base class and are mandatory. if more params are needed, super can</span>
<span class="sd">        be used to init a different provider_config and is_verbose_output.</span>

<span class="sd">        &quot;schema&quot; is an optional parameter containing a jsonschema</span>
<span class="sd">        object (dict). If initialized it will automatically trigger schema</span>
<span class="sd">        validation for the provider. Schema validation will be performed</span>
<span class="sd">        using the default validate_schema method (from the base class).</span>
<span class="sd">        a new &quot;validate_schema&quot; method can be supplied if needed to replace</span>
<span class="sd">        the default one.</span>

<span class="sd">        :param dict provider_config: inherits the config yaml from the cli</span>
<span class="sd">        :param bool is_verbose_output: self explanatory</span>
<span class="sd">        :param dict schema: json schema for validation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_keystone_from_environment</span><span class="p">(</span><span class="n">provider_config</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">ProviderManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">provider_config</span><span class="p">,</span>
                                              <span class="n">is_verbose_output</span><span class="p">,</span>
                                              <span class="n">schema</span><span class="o">=</span><span class="n">PROVIDER_CONFIG_SCHEMA</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_modify_keystone_from_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="n">keystone_exists</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">keystone_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;keystone&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keystone_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">keystone_exists</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keystone_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_key_by_environ</span><span class="p">(</span><span class="n">keystone_config</span><span class="p">,</span> <span class="s">&quot;username&quot;</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span>
                                    <span class="s">&quot;OS_USERNAME&quot;</span><span class="p">,</span>
                                    <span class="p">[</span><span class="s">&quot;Enter-Openstack-Username-Here&quot;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_key_by_environ</span><span class="p">(</span><span class="n">keystone_config</span><span class="p">,</span> <span class="s">&quot;password&quot;</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span>
                                    <span class="s">&quot;OS_PASSWORD&quot;</span><span class="p">,</span>
                                    <span class="p">[</span><span class="s">&quot;Enter-Openstack-Password-Here&quot;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_key_by_environ</span><span class="p">(</span><span class="n">keystone_config</span><span class="p">,</span> <span class="s">&quot;tenant_name&quot;</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span>
                                    <span class="s">&quot;OS_TENANT_NAME&quot;</span><span class="p">,</span>
                                    <span class="p">[</span><span class="s">&quot;Enter-Openstack-Tenant-Name-Here&quot;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_key_by_environ</span><span class="p">(</span><span class="n">keystone_config</span><span class="p">,</span> <span class="s">&quot;tenant_id&quot;</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span>
                                    <span class="s">&quot;OS_TENANT_ID&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_key_by_environ</span><span class="p">(</span><span class="n">keystone_config</span><span class="p">,</span> <span class="s">&quot;auth_url&quot;</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span>
                                    <span class="s">&quot;OS_AUTH_URL&quot;</span><span class="p">,</span>
                                    <span class="p">[</span><span class="s">&#39;Enter-Openstack-Auth-Url-Here&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keystone_exists</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keystone_config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="s">&#39;keystone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keystone_config</span>

    <span class="k">def</span> <span class="nf">_modify_key_by_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span>
                               <span class="n">env_var_name</span><span class="p">,</span> <span class="n">default_values</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">in</span> <span class="n">default_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">env_var_name</span> <span class="ow">in</span> <span class="n">environ</span><span class="p">:</span>
                <span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="n">env_var_name</span><span class="p">]</span>

<div class="viewcode-block" id="ProviderManager.provision"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.ProviderManager.provision">[docs]</a>    <span class="k">def</span> <span class="nf">provision</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        provisions resources for the management server</span>

<span class="sd">        returns a tuple with the machine&#39;s public and private ip&#39;s,</span>
<span class="sd">        the ssh key and user configured in the config yaml and</span>
<span class="sd">        the prorivder&#39;s context (a dict containing the privisioned</span>
<span class="sd">        resources to be used during teardown)</span>

<span class="sd">        the tuple&#39;s order should correspond with the above order.</span>

<span class="sd">        :rtype: &#39;tuple&#39; with machine context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_driver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_config</span><span class="p">)</span>
        <span class="n">public_ip</span><span class="p">,</span> <span class="n">private_ip</span><span class="p">,</span> <span class="n">ssh_key</span><span class="p">,</span> <span class="n">ssh_user</span><span class="p">,</span> <span class="n">provider_context</span> <span class="o">=</span> \
            <span class="n">driver</span><span class="o">.</span><span class="n">create_topology</span><span class="p">()</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">copy_files_to_manager</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">ssh_key</span><span class="p">,</span> <span class="n">ssh_user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">public_ip</span><span class="p">,</span> <span class="n">private_ip</span><span class="p">,</span> <span class="n">ssh_key</span><span class="p">,</span> <span class="n">ssh_user</span><span class="p">,</span> <span class="n">provider_context</span>
</div>
<div class="viewcode-block" id="ProviderManager.validate"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.ProviderManager.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_errors</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        validations to be performed before provisioning and bootstrapping</span>
<span class="sd">        the management server.</span>

<span class="sd">        returns a dict of lists of validation errors. each list corresponds</span>
<span class="sd">        with a logical section of the validations (e.g, compute, networking..)</span>

<span class="sd">        Note: provisioning will continue only if the returned dict is empty.</span>

<span class="sd">        :param dict schema: a schema dict to validate the provider config</span>
<span class="sd">         against</span>
<span class="sd">        :rtype: &#39;dict&#39; of validation_errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># get openstack clients</span>
        <span class="n">connector</span> <span class="o">=</span> <span class="n">OpenStackConnector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_config</span><span class="p">)</span>
        <span class="c"># get verifier object</span>
        <span class="n">verifier</span> <span class="o">=</span> <span class="n">OpenStackValidator</span><span class="p">(</span><span class="n">validation_errors</span><span class="p">,</span>
                                      <span class="n">connector</span><span class="o">.</span><span class="n">get_nova_client</span><span class="p">(),</span>
                                      <span class="n">connector</span><span class="o">.</span><span class="n">get_neutron_client</span><span class="p">(),</span>
                                      <span class="n">connector</span><span class="o">.</span><span class="n">get_keystone_client</span><span class="p">())</span>

        <span class="c"># get config</span>
        <span class="c"># keystone_config = provider_config[&#39;keystone&#39;]</span>
        <span class="n">networking_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">]</span>
        <span class="n">compute_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_config</span><span class="p">[</span><span class="s">&#39;compute&#39;</span><span class="p">]</span>
        <span class="c"># cloudify_config = provider_config[&#39;cloudify&#39;]</span>
        <span class="n">mgmt_server_config</span> <span class="o">=</span> <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">]</span>
        <span class="n">agent_server_config</span> <span class="o">=</span> <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;agent_servers&#39;</span><span class="p">]</span>
        <span class="c"># mgmt_instance_config = mgmt_server_config[&#39;instance&#39;]</span>
        <span class="n">mgmt_keypair_config</span> <span class="o">=</span> <span class="n">mgmt_server_config</span><span class="p">[</span><span class="s">&#39;management_keypair&#39;</span><span class="p">]</span>
        <span class="n">agent_keypair_config</span> <span class="o">=</span> <span class="n">agent_server_config</span><span class="p">[</span><span class="s">&#39;agents_keypair&#39;</span><span class="p">]</span>

        <span class="c"># validate</span>
        <span class="n">verifier</span><span class="o">.</span><span class="n">validate_cidr_syntax</span><span class="p">(</span>
            <span class="s">&#39;networking.subnet.cidr&#39;</span><span class="p">,</span>
            <span class="n">networking_config</span><span class="p">[</span><span class="s">&#39;subnet&#39;</span><span class="p">][</span><span class="s">&#39;cidr&#39;</span><span class="p">])</span>
        <span class="n">verifier</span><span class="o">.</span><span class="n">validate_cidr_syntax</span><span class="p">(</span>
            <span class="s">&#39;networking.management_security_group.cidr&#39;</span><span class="p">,</span>
            <span class="n">networking_config</span><span class="p">[</span><span class="s">&#39;management_security_group&#39;</span><span class="p">][</span><span class="s">&#39;cidr&#39;</span><span class="p">])</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;validating networking resources...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;neutron_url&#39;</span> <span class="ow">in</span> <span class="n">networking_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">verifier</span><span class="o">.</span><span class="n">validate_url_accessible</span><span class="p">(</span>
                <span class="s">&#39;networking.network_url&#39;</span><span class="p">,</span>
                <span class="n">networking_config</span><span class="p">[</span><span class="s">&#39;neutron_url&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s">&#39;router&#39;</span> <span class="ow">in</span> <span class="n">networking_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">verifier</span><span class="o">.</span><span class="n">validate_neutron_resource</span><span class="p">(</span>
                <span class="s">&#39;networking.router.name&#39;</span><span class="p">,</span>
                <span class="n">networking_config</span><span class="p">[</span><span class="s">&#39;router&#39;</span><span class="p">],</span>
                <span class="n">resource_type</span><span class="o">=</span><span class="s">&#39;router&#39;</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s">&#39;list_routers&#39;</span><span class="p">)</span>
        <span class="n">verifier</span><span class="o">.</span><span class="n">validate_neutron_resource</span><span class="p">(</span>
            <span class="s">&#39;networking.subnet.name&#39;</span><span class="p">,</span>
            <span class="n">networking_config</span><span class="p">[</span><span class="s">&#39;subnet&#39;</span><span class="p">],</span>
            <span class="n">resource_type</span><span class="o">=</span><span class="s">&#39;subnet&#39;</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s">&#39;list_subnets&#39;</span><span class="p">)</span>
        <span class="n">verifier</span><span class="o">.</span><span class="n">validate_neutron_resource</span><span class="p">(</span>
            <span class="s">&#39;networking.int_network.name&#39;</span><span class="p">,</span>
            <span class="n">networking_config</span><span class="p">[</span><span class="s">&#39;int_network&#39;</span><span class="p">],</span>
            <span class="n">resource_type</span><span class="o">=</span><span class="s">&#39;network&#39;</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s">&#39;list_networks&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;agents_security_group&#39;</span> <span class="ow">in</span> <span class="n">networking_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">verifier</span><span class="o">.</span><span class="n">validate_neutron_resource</span><span class="p">(</span>
                <span class="s">&#39;networking.agents_security_group.name&#39;</span><span class="p">,</span>
                <span class="n">networking_config</span><span class="p">[</span><span class="s">&#39;agents_security_group&#39;</span><span class="p">],</span>
                <span class="n">resource_type</span><span class="o">=</span><span class="s">&#39;security_group&#39;</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s">&#39;list_security_groups&#39;</span><span class="p">)</span>
        <span class="n">verifier</span><span class="o">.</span><span class="n">validate_neutron_resource</span><span class="p">(</span>
            <span class="s">&#39;networking.management_security_group.name&#39;</span><span class="p">,</span>
            <span class="n">networking_config</span><span class="p">[</span><span class="s">&#39;management_security_group&#39;</span><span class="p">],</span>
            <span class="n">resource_type</span><span class="o">=</span><span class="s">&#39;security_group&#39;</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s">&#39;list_security_groups&#39;</span><span class="p">)</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;validating compute resources...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;floating_ip&#39;</span> <span class="ow">in</span> <span class="n">mgmt_server_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
                <span class="ow">and</span> <span class="n">verifier</span><span class="o">.</span><span class="n">validate_cidr_syntax</span><span class="p">(</span>
                    <span class="s">&#39;compute.management_server.floating_ip&#39;</span><span class="p">,</span>
                    <span class="n">mgmt_server_config</span><span class="p">[</span><span class="s">&#39;floating_ip&#39;</span><span class="p">]):</span>
            <span class="n">verifier</span><span class="o">.</span><span class="n">validate_floating_ip</span><span class="p">(</span>
                <span class="s">&#39;compute.management_server.floating_ip&#39;</span><span class="p">,</span>
                <span class="n">mgmt_server_config</span><span class="p">[</span><span class="s">&#39;floating_ip&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verifier</span><span class="o">.</span><span class="n">validate_floating_ip</span><span class="p">(</span>
                <span class="s">&#39;compute.management_server.floating_ip&#39;</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">)</span>
        <span class="n">verifier</span><span class="o">.</span><span class="n">validate_image_exists</span><span class="p">(</span>
            <span class="s">&#39;compute.management_server.instance.image&#39;</span><span class="p">,</span>
            <span class="n">mgmt_server_config</span><span class="p">[</span><span class="s">&#39;instance&#39;</span><span class="p">][</span><span class="s">&#39;image&#39;</span><span class="p">])</span>
        <span class="n">verifier</span><span class="o">.</span><span class="n">validate_flavor_exists</span><span class="p">(</span>
            <span class="s">&#39;compute.management_server.instance.flavor&#39;</span><span class="p">,</span>
            <span class="n">mgmt_server_config</span><span class="p">[</span><span class="s">&#39;instance&#39;</span><span class="p">][</span><span class="s">&#39;flavor&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="ow">in</span> <span class="n">linuxd</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verifier</span><span class="o">.</span><span class="n">check_key_exists</span><span class="p">(</span>
                <span class="n">mgmt_keypair_config</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">]</span>
                                   <span class="p">[</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">]):</span>
                <span class="n">verifier</span><span class="o">.</span><span class="n">validate_key_perms</span><span class="p">(</span>
                    <span class="s">&#39;compute.management_server.management_keypair&#39;</span>
                    <span class="s">&#39;.auto_generated.private_key_target_path&#39;</span><span class="p">,</span>
                    <span class="n">mgmt_keypair_config</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">]</span>
                                       <span class="p">[</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">])</span>
                <span class="n">verifier</span><span class="o">.</span><span class="n">validate_path_owner</span><span class="p">(</span>
                    <span class="s">&#39;compute.management_server.management_keypair&#39;</span>
                    <span class="s">&#39;.auto_generated.private_key_target_path&#39;</span><span class="p">,</span>
                    <span class="n">mgmt_keypair_config</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">]</span>
                                       <span class="p">[</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">verifier</span><span class="o">.</span><span class="n">check_key_exists</span><span class="p">(</span>
                <span class="n">agent_keypair_config</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">]</span>
                                    <span class="p">[</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">]):</span>
                <span class="n">verifier</span><span class="o">.</span><span class="n">validate_key_perms</span><span class="p">(</span>
                    <span class="s">&#39;compute.agent_servers.agents_keypair&#39;</span>
                    <span class="s">&#39;.auto_generated.private_key_target_path&#39;</span><span class="p">,</span>
                    <span class="n">agent_keypair_config</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">]</span>
                                        <span class="p">[</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">])</span>
                <span class="n">verifier</span><span class="o">.</span><span class="n">validate_path_owner</span><span class="p">(</span>
                    <span class="s">&#39;compute.agent_servers.agents_keypair&#39;</span>
                    <span class="s">&#39;.auto_generated.private_key_target_path&#39;</span><span class="p">,</span>
                    <span class="n">agent_keypair_config</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">]</span>
                                        <span class="p">[</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">])</span>

        <span class="c"># TODO: check cloudify package url accessiblity from</span>
        <span class="c"># within the instance</span>
        <span class="c"># lgr.info(&#39;validating cloudify resources...&#39;)</span>
        <span class="c"># verifier.validate_url_accessible(</span>
        <span class="c">#     &#39;cloudify.cloudify_components_package_url&#39;,</span>
        <span class="c">#     cloudify_config[&#39;cloudify_components_package_url&#39;])</span>
        <span class="c"># verifier.validate_url_accessible(</span>
        <span class="c">#     &#39;cloudify.cloudify_package_url&#39;,</span>
        <span class="c">#     cloudify_config[&#39;cloudify_package_url&#39;])</span>

        <span class="c"># TODO:</span>
        <span class="c"># verifier.validate_security_rules()</span>
        <span class="c"># undeliverable due to keystone client bug</span>
        <span class="c"># verifier.validate_keystone_service_exists(&#39;nova&#39;)</span>
        <span class="c"># verifier.validate_keystone_service_exists(&#39;neutron&#39;)</span>
        <span class="c"># undeliverable due to nova client bug</span>
        <span class="c"># verifier.validate_instance_quota()</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;resource validation failed!&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">validation_errors</span> \
            <span class="k">else</span> <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;resources validated successfully&#39;</span><span class="p">)</span>
        <span class="c"># print json.dumps(validation_errors, sort_keys=True,</span>
        <span class="c">#                  indent=4, separators=(&#39;,&#39;, &#39;: &#39;))</span>
        <span class="k">return</span> <span class="n">validation_errors</span>
</div>
<div class="viewcode-block" id="ProviderManager.teardown"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.ProviderManager.teardown">[docs]</a>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_context</span><span class="p">,</span> <span class="n">ignore_validation</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        tears down the management server and its accompanied provisioned</span>
<span class="sd">        resources</span>

<span class="sd">        :param dict provider_context: context information with the previously</span>
<span class="sd">         provisioned resources</span>
<span class="sd">        :param bool ignore_validation: should the teardown process ignore</span>
<span class="sd">         conflicts during teardown</span>
<span class="sd">        :rtype: &#39;None&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_driver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_config</span><span class="p">,</span> <span class="n">provider_context</span><span class="p">)</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">delete_topology</span><span class="p">(</span><span class="n">ignore_validation</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_config</span><span class="p">,</span> <span class="n">provider_context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        comfort driver for provisioning and teardown.</span>
<span class="sd">        this is not a mandatory method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">provider_context</span> <span class="o">=</span> <span class="n">provider_context</span> <span class="k">if</span> <span class="n">provider_context</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">connector</span> <span class="o">=</span> <span class="n">OpenStackConnector</span><span class="p">(</span><span class="n">provider_config</span><span class="p">)</span>
        <span class="n">network_controller</span> <span class="o">=</span> <span class="n">OpenStackNetworkController</span><span class="p">(</span><span class="n">connector</span><span class="p">)</span>
        <span class="n">subnet_controller</span> <span class="o">=</span> <span class="n">OpenStackSubnetController</span><span class="p">(</span><span class="n">connector</span><span class="p">)</span>
        <span class="n">router_controller</span> <span class="o">=</span> <span class="n">OpenStackRouterController</span><span class="p">(</span><span class="n">connector</span><span class="p">)</span>
        <span class="n">floating_ip_controller</span> <span class="o">=</span> <span class="n">OpenStackFloatingIpController</span><span class="p">(</span><span class="n">connector</span><span class="p">)</span>
        <span class="n">keypair_controller</span> <span class="o">=</span> <span class="n">OpenStackKeypairController</span><span class="p">(</span><span class="n">connector</span><span class="p">)</span>
        <span class="n">server_controller</span> <span class="o">=</span> <span class="n">OpenStackServerController</span><span class="p">(</span><span class="n">connector</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">provider_config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;neutron_supported_region&#39;</span><span class="p">]:</span>
            <span class="n">sg_controller</span> <span class="o">=</span> <span class="n">OpenStackNeutronSecurityGroupController</span><span class="p">(</span><span class="n">connector</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sg_controller</span> <span class="o">=</span> <span class="n">OpenStackNovaSecurityGroupController</span><span class="p">(</span><span class="n">connector</span><span class="p">)</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">CosmoOnOpenStackDriver</span><span class="p">(</span>
            <span class="n">provider_config</span><span class="p">,</span> <span class="n">provider_context</span><span class="p">,</span> <span class="n">network_controller</span><span class="p">,</span>
            <span class="n">subnet_controller</span><span class="p">,</span> <span class="n">router_controller</span><span class="p">,</span> <span class="n">sg_controller</span><span class="p">,</span>
            <span class="n">floating_ip_controller</span><span class="p">,</span> <span class="n">keypair_controller</span><span class="p">,</span> <span class="n">server_controller</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">driver</span>

</div>
<span class="k">def</span> <span class="nf">_format_resource_name</span><span class="p">(</span><span class="n">res_type</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">res_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">res_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;{0} - {1} - {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_type</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">res_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;{0} - {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_type</span><span class="p">,</span> <span class="n">res_id</span><span class="p">)</span>


<div class="viewcode-block" id="OpenStackValidator"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator">[docs]</a><span class="k">class</span> <span class="nc">OpenStackValidator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for every mandatory config element, we&#39;ll verify access or existence.</span>

<span class="sd">    for every config element that is marked as create_if_missing = False</span>
<span class="sd">    we&#39;ll verify that the element exists and if it doesn&#39;t, alert.</span>

<span class="sd">    for every config element that is marked as create_if_missing = True</span>
<span class="sd">    we&#39;ll check if the element exists and if it doesn&#39;t, check if there&#39;s</span>
<span class="sd">    quota to create the element, and if there isn&#39;t, alert.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_errors</span><span class="p">,</span> <span class="n">nova_client</span><span class="p">,</span> <span class="n">neutron_client</span><span class="p">,</span>
                 <span class="n">keystone_client</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span> <span class="o">=</span> <span class="n">validation_errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span> <span class="o">=</span> <span class="n">nova_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span> <span class="o">=</span> <span class="n">neutron_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keystone_client</span> <span class="o">=</span> <span class="n">keystone_client</span>

    <span class="k">def</span> <span class="nf">_get_neutron_quota</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="n">quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">show_quota</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keystone_client</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)[</span><span class="s">&#39;quota&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">quotas</span><span class="p">[</span><span class="n">resource</span><span class="p">]</span>

<div class="viewcode-block" id="OpenStackValidator.validate_floating_ip"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator.validate_floating_ip">[docs]</a>    <span class="k">def</span> <span class="nf">validate_floating_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">floating_ip</span><span class="p">):</span>
        <span class="n">ips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">list_floatingips</span><span class="p">()</span>
        <span class="n">ips_amount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ips</span><span class="p">[</span><span class="s">&#39;floatingips&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">floating_ip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking whether floating_ip {0} exists...&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">floating_ip</span><span class="p">))</span>
            <span class="n">found_floating_ip</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ips</span><span class="p">[</span><span class="s">&#39;floatingips&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">ip</span><span class="p">[</span><span class="s">&#39;floating_ip_address&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">floating_ip</span><span class="p">:</span>
                    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                              <span class="s">&#39;floating_ip {0} is allocated&#39;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">floating_ip</span><span class="p">))</span>
                    <span class="n">found_floating_ip</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_floating_ip</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
                       <span class="s">&#39;floating_ip {1} is not allocated.&#39;</span>
                       <span class="s">&#39; please provide an allocated address&#39;</span>
                       <span class="s">&#39; or comment the floating_ip line in the config&#39;</span>
                       <span class="s">&#39; and one will be allocated for you.&#39;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">floating_ip</span><span class="p">))</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;list of available floating ips:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ips</span><span class="p">[</span><span class="s">&#39;floatingips&#39;</span><span class="p">]:</span>
                    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;    {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">[</span><span class="s">&#39;floating_ip_address&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;networking&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking whether quota allows allocation&#39;</span>
                      <span class="s">&#39; of new floating ips&#39;</span><span class="p">)</span>
            <span class="n">ips_quota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_neutron_quota</span><span class="p">(</span><span class="s">&#39;floatingip&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ips_amount</span> <span class="o">&lt;</span> <span class="n">ips_quota</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                          <span class="s">&#39;a new ip can be allocated.&#39;</span>
                          <span class="s">&#39; provisioned ips: {0}, quota: {1}&#39;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ips_amount</span><span class="p">,</span> <span class="n">ips_quota</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
                       <span class="s">&#39;a floating ip cannot be allocated due&#39;</span>
                       <span class="s">&#39; to quota limitations.&#39;</span>
                       <span class="s">&#39; privisioned ips: {1}, quota: {2}&#39;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ips_amount</span><span class="p">,</span> <span class="n">ips_quota</span><span class="p">))</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;networking&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="OpenStackValidator.validate_neutron_resource"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator.validate_neutron_resource">[docs]</a>    <span class="k">def</span> <span class="nf">validate_neutron_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">resource_config</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span>
                                  <span class="n">method</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking whether {0} {1} exists...&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_config</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]))</span>
        <span class="n">resource_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="p">,</span> <span class="n">method</span><span class="p">)()</span>
        <span class="n">resource_amount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resource_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resource_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">resource</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">resource_config</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                          <span class="s">&#39;{0} {1} found in pool&#39;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_config</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]))</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource_config</span><span class="p">[</span><span class="n">CREATE_IF_MISSING</span><span class="p">]:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
                   <span class="s">&#39;{1} {2} does not exist in the pool but is marked as&#39;</span>
                   <span class="s">&#39; create_if_missing = False. please provide an existing&#39;</span>
                   <span class="s">&#39; resource name or change create_if_missing = True&#39;</span>
                   <span class="s">&#39; to automatically create a new resource.&#39;</span>
                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_config</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]))</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;list of available {0}s:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource_type</span><span class="p">))</span>
            <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="nb">all</span> <span class="ow">in</span> <span class="n">resource_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="nb">all</span><span class="p">:</span>
                    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;    {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;networking&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resource_quota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_neutron_quota</span><span class="p">(</span><span class="n">resource_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resource_amount</span> <span class="o">&lt;</span> <span class="n">resource_quota</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                          <span class="s">&#39;{0} {1} can be created.&#39;</span>
                          <span class="s">&#39; privisioned {2}s: {3}, quota: {4}&#39;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_config</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                                  <span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_amount</span><span class="p">,</span>
                                  <span class="n">resource_quota</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
                       <span class="s">&#39;{1} {2} cannot be created due&#39;</span>
                       <span class="s">&#39; to quota limitations.&#39;</span>
                       <span class="s">&#39; privisioned {3}s: {4}, quota: {5}&#39;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_config</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                               <span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_amount</span><span class="p">,</span>
                               <span class="n">resource_quota</span><span class="p">))</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;networking&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="OpenStackValidator.validate_cidr_syntax"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator.validate_cidr_syntax">[docs]</a>    <span class="k">def</span> <span class="nf">validate_cidr_syntax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">cidr</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking whether {0} is a valid address range...&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cidr</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">IP</span><span class="p">(</span><span class="n">cidr</span><span class="p">)</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                      <span class="s">&#39;{0} is a valid address range.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cidr</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
                   <span class="s">&#39;{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;networking&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="OpenStackValidator.validate_image_exists"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator.validate_image_exists">[docs]</a>    <span class="k">def</span> <span class="nf">validate_image_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking whether image {0} exists...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
        <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">human_id</span> <span class="ow">or</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                          <span class="s">&#39;image {0} exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
               <span class="s">&#39;image {1} does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">image</span><span class="p">))</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;list of available images:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;    {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;compute&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="OpenStackValidator.validate_flavor_exists"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator.validate_flavor_exists">[docs]</a>    <span class="k">def</span> <span class="nf">validate_flavor_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">flavor</span><span class="p">):</span>
        <span class="n">flavor</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">flavor</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking whether flavor {0} exists...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flavor</span><span class="p">))</span>
        <span class="n">flavors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">flavors</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flavors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flavor</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">flavor</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">human_id</span> <span class="ow">or</span> <span class="n">flavor</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                          <span class="s">&#39;flavor {0} exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flavor</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
               <span class="s">&#39;flavor {1} does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">flavor</span><span class="p">))</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;list of available flavors:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flavors</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;    {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;compute&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="OpenStackValidator.check_key_exists"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator.check_key_exists">[docs]</a>    <span class="k">def</span> <span class="nf">check_key_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_path</span><span class="p">):</span>
        <span class="c"># lgr.debug(&#39;checking whether key {0} exists&#39;</span>
        <span class="c">#           .format(key_path))</span>
        <span class="n">key_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">key_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">key_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="OpenStackValidator.validate_key_perms"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator.validate_key_perms">[docs]</a>    <span class="k">def</span> <span class="nf">validate_key_perms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">key_path</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking whether key {0} has the right permissions&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_path</span><span class="p">))</span>
        <span class="n">key_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">key_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">(</span><span class="nb">oct</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">key_path</span><span class="p">)[</span><span class="n">ST_MODE</span><span class="p">])[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span> <span class="o">&lt;=</span> <span class="n">MINIMAL_KEY_PERMS</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
                   <span class="s">&#39;ssh key {1} does not have the correct permissions&#39;</span>
                   <span class="s">&#39;({2}).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">MINIMAL_KEY_PERMS</span><span class="p">))</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;copmute&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                  <span class="s">&#39;ssh key {0} has the correct permissions&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="OpenStackValidator.validate_url_accessible"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator.validate_url_accessible">[docs]</a>    <span class="k">def</span> <span class="nf">validate_url_accessible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">package_url</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking whether url {0} is accessible&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package_url</span><span class="p">))</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">package_url</span><span class="p">)</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
                   <span class="s">&#39;url {1} is not accessible&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">package_url</span><span class="p">))</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;cloudify&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                  <span class="s">&#39;url {0} is accessible&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package_url</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="OpenStackValidator.validate_path_owner"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackValidator.validate_path_owner">[docs]</a>    <span class="k">def</span> <span class="nf">validate_path_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking whether dir {0} is owned by the current user&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="kn">from</span> <span class="nn">pwd</span> <span class="kn">import</span> <span class="n">getpwnam</span><span class="p">,</span> <span class="n">getpwuid</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">getuser</span><span class="p">()</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_uid</span><span class="p">)</span><span class="o">.</span><span class="n">pw_name</span>
        <span class="n">current_user_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">)</span>
        <span class="n">owner_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_uid</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user_id</span> <span class="o">==</span> <span class="n">owner_id</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;config file validation error originating at key: {0}, &#39;</span>
                   <span class="s">&#39;{1} is not owned by the current user&#39;</span>
                   <span class="s">&#39; (it is owned by {2})&#39;</span>
                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">owner</span><span class="p">))</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;VALIDATION ERROR:&#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;compute&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;OK:&#39;</span>
                  <span class="s">&#39;{0} is owned by the current user&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>

</div></div>
<div class="viewcode-block" id="CosmoOnOpenStackDriver"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.CosmoOnOpenStackDriver">[docs]</a><span class="k">class</span> <span class="nc">CosmoOnOpenStackDriver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    in change or provisioning and teardown of resources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_config</span><span class="p">,</span> <span class="n">provider_context</span><span class="p">,</span> <span class="n">network_controller</span><span class="p">,</span>
                 <span class="n">subnet_controller</span><span class="p">,</span> <span class="n">router_controller</span><span class="p">,</span> <span class="n">sg_controller</span><span class="p">,</span>
                 <span class="n">floating_ip_controller</span><span class="p">,</span> <span class="n">keypair_controller</span><span class="p">,</span>
                 <span class="n">server_controller</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">provider_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider_context</span> <span class="o">=</span> <span class="n">provider_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_controller</span> <span class="o">=</span> <span class="n">network_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subnet_controller</span> <span class="o">=</span> <span class="n">subnet_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router_controller</span> <span class="o">=</span> <span class="n">router_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sg_controller</span> <span class="o">=</span> <span class="n">sg_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">floating_ip_controller</span> <span class="o">=</span> <span class="n">floating_ip_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keypair_controller</span> <span class="o">=</span> <span class="n">keypair_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_controller</span> <span class="o">=</span> <span class="n">server_controller</span>

        <span class="k">global</span> <span class="n">verbose_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose_output</span> <span class="o">=</span> <span class="n">verbose_output</span>

<div class="viewcode-block" id="CosmoOnOpenStackDriver.copy_files_to_manager"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.CosmoOnOpenStackDriver.copy_files_to_manager">[docs]</a>    <span class="k">def</span> <span class="nf">copy_files_to_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mgmt_ip</span><span class="p">,</span> <span class="n">ssh_key</span><span class="p">,</span> <span class="n">ssh_user</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_copy</span><span class="p">(</span><span class="n">userhome_on_management</span><span class="p">,</span>
                  <span class="n">keystone_config</span><span class="p">,</span> <span class="n">agents_key_path</span><span class="p">,</span>
                  <span class="n">networking</span><span class="p">):</span>

            <span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">ssh_user</span>
            <span class="n">env</span><span class="o">.</span><span class="n">key_filename</span> <span class="o">=</span> <span class="n">ssh_key</span>
            <span class="n">env</span><span class="o">.</span><span class="n">abort_on_prompts</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">env</span><span class="o">.</span><span class="n">connection_attempts</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="n">env</span><span class="o">.</span><span class="n">keepalive</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">env</span><span class="o">.</span><span class="n">linewise</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">env</span><span class="o">.</span><span class="n">pool_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">env</span><span class="o">.</span><span class="n">skip_bad_hosts</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">env</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">env</span><span class="o">.</span><span class="n">forward_agent</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">env</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">env</span><span class="o">.</span><span class="n">disable_known_hosts</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;uploading keystone and neutron files to manager&#39;</span><span class="p">)</span>
            <span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

            <span class="c"># TODO: handle failed copy operations</span>
            <span class="n">put</span><span class="p">(</span><span class="n">agents_key_path</span><span class="p">,</span> <span class="n">userhome_on_management</span> <span class="o">+</span> <span class="s">&#39;/.ssh&#39;</span><span class="p">)</span>
            <span class="n">keystone_file_path</span> <span class="o">=</span> <span class="n">_make_keystone_file</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span>
                                                     <span class="n">keystone_config</span><span class="p">)</span>
            <span class="n">put</span><span class="p">(</span><span class="n">keystone_file_path</span><span class="p">,</span> <span class="n">userhome_on_management</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">networking</span><span class="p">[</span><span class="s">&#39;neutron_supported_region&#39;</span><span class="p">]:</span>
                <span class="n">neutron_file_path</span> <span class="o">=</span> <span class="n">_make_neutron_file</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span>
                                                       <span class="n">networking</span><span class="p">)</span>
                <span class="n">put</span><span class="p">(</span><span class="n">neutron_file_path</span><span class="p">,</span> <span class="n">userhome_on_management</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_make_keystone_file</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">keystone_config</span><span class="p">):</span>
            <span class="c"># put default region in keystone_config file</span>
            <span class="n">keystone_config</span><span class="p">[</span><span class="s">&#39;region&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;compute&#39;</span><span class="p">][</span><span class="s">&#39;region&#39;</span><span class="p">]</span>
            <span class="n">keystone_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="s">&#39;keystone_config.json&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">keystone_file_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">keystone_config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">keystone_file_path</span>

        <span class="k">def</span> <span class="nf">_make_neutron_file</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">networking</span><span class="p">):</span>
            <span class="n">neutron_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="s">&#39;neutron_config.json&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">neutron_file_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="n">networking</span><span class="p">[</span><span class="s">&#39;neutron_url&#39;</span><span class="p">]},</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">neutron_file_path</span>

        <span class="k">def</span> <span class="nf">_get_private_key_path_from_keypair_config</span><span class="p">(</span><span class="n">keypair_config</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">keypair_config</span><span class="p">[</span><span class="s">&#39;provided&#39;</span><span class="p">][</span><span class="s">&#39;private_key_filepath&#39;</span><span class="p">]</span> <span class="k">if</span> \
                <span class="s">&#39;provided&#39;</span> <span class="ow">in</span> <span class="n">keypair_config</span> <span class="k">else</span> \
                <span class="n">keypair_config</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">][</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">compute_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;compute&#39;</span><span class="p">]</span>
        <span class="n">mgmt_server_config</span> <span class="o">=</span> <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">host_string</span><span class="o">=</span><span class="n">mgmt_ip</span><span class="p">):</span>
            <span class="n">_copy</span><span class="p">(</span>
                <span class="n">mgmt_server_config</span><span class="p">[</span><span class="s">&#39;userhome_on_management&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;keystone&#39;</span><span class="p">],</span>
                <span class="n">_get_private_key_path_from_keypair_config</span><span class="p">(</span>
                    <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;agent_servers&#39;</span><span class="p">][</span><span class="s">&#39;agents_keypair&#39;</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="CosmoOnOpenStackDriver.create_topology"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.CosmoOnOpenStackDriver.create_topology">[docs]</a>    <span class="k">def</span> <span class="nf">create_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider_context</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resources</span>

        <span class="n">compute_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;compute&#39;</span><span class="p">]</span>
        <span class="n">insconf</span> <span class="o">=</span> <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">][</span><span class="s">&#39;instance&#39;</span><span class="p">]</span>

        <span class="n">is_neutron_supported_region</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;neutron_supported_region&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_neutron_supported_region</span><span class="p">:</span>
            <span class="n">nconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;int_network&#39;</span><span class="p">]</span>
            <span class="n">net_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_controller</span>\
                <span class="o">.</span><span class="n">create_or_ensure_exists_log_resources</span><span class="p">(</span>
                    <span class="n">nconf</span><span class="p">,</span>
                    <span class="n">nconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">resources</span><span class="p">,</span>
                    <span class="s">&#39;int_network&#39;</span><span class="p">,</span>
                    <span class="bp">False</span><span class="p">)</span>

            <span class="n">sconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;subnet&#39;</span><span class="p">]</span>
            <span class="n">subnet_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subnet_controller</span><span class="o">.</span>\
                <span class="n">create_or_ensure_exists_log_resources</span><span class="p">(</span>
                    <span class="n">sconf</span><span class="p">,</span>
                    <span class="n">sconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">resources</span><span class="p">,</span>
                    <span class="s">&#39;subnet&#39;</span><span class="p">,</span>
                    <span class="bp">False</span><span class="p">,</span>
                    <span class="n">sconf</span><span class="p">[</span><span class="s">&#39;ip_version&#39;</span><span class="p">],</span>
                    <span class="n">sconf</span><span class="p">[</span><span class="s">&#39;cidr&#39;</span><span class="p">],</span>
                    <span class="n">sconf</span><span class="p">[</span><span class="s">&#39;dns_nameservers&#39;</span><span class="p">],</span>
                    <span class="n">net_id</span><span class="p">)</span>

            <span class="n">enconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;ext_network&#39;</span><span class="p">]</span>
            <span class="n">enet_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_controller</span><span class="o">.</span>\
                <span class="n">create_or_ensure_exists_log_resources</span><span class="p">(</span>
                    <span class="n">enconf</span><span class="p">,</span>
                    <span class="n">enconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">resources</span><span class="p">,</span>
                    <span class="s">&#39;ext_network&#39;</span><span class="p">,</span>
                    <span class="bp">False</span><span class="p">,</span>
                    <span class="n">ext</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">rconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;router&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">router_controller</span><span class="o">.</span>\
                <span class="n">create_or_ensure_exists_log_resources</span><span class="p">(</span>
                    <span class="n">rconf</span><span class="p">,</span>
                    <span class="n">rconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">resources</span><span class="p">,</span>
                    <span class="s">&#39;router&#39;</span><span class="p">,</span>
                    <span class="bp">False</span><span class="p">,</span>
                    <span class="n">interfaces</span><span class="o">=</span><span class="p">[{</span><span class="s">&#39;subnet_id&#39;</span><span class="p">:</span> <span class="n">subnet_id</span><span class="p">}],</span>
                    <span class="n">external_gateway_info</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;network_id&quot;</span><span class="p">:</span> <span class="n">enet_id</span><span class="p">})</span>

            <span class="n">insconf</span><span class="p">[</span><span class="s">&#39;nics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&#39;net-id&#39;</span><span class="p">:</span> <span class="n">net_id</span><span class="p">}]</span>

        <span class="c"># Security group for Cosmo created instances</span>
        <span class="n">asgconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;agents_security_group&#39;</span><span class="p">]</span>
        <span class="n">asg_id</span><span class="p">,</span> <span class="n">agent_sg_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg_controller</span><span class="o">.</span>\
            <span class="n">create_or_ensure_exists_log_resources</span><span class="p">(</span>
                <span class="n">asgconf</span><span class="p">,</span>
                <span class="n">asgconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">resources</span><span class="p">,</span>
                <span class="s">&#39;agents_security_group&#39;</span><span class="p">,</span>
                <span class="bp">True</span><span class="p">,</span>
                <span class="s">&#39;Cosmo created machines&#39;</span><span class="p">,</span>
                <span class="p">[])</span>

        <span class="c"># Security group for Cosmo manager, allows created</span>
        <span class="c"># instances -&gt; manager communication</span>
        <span class="n">msgconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;management_security_group&#39;</span><span class="p">]</span>
        <span class="n">sg_rules</span> <span class="o">=</span> \
            <span class="p">[{</span><span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s">&#39;group_id&#39;</span><span class="p">:</span> <span class="n">asg_id</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">INTERNAL_MGMT_PORTS</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">[{</span><span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s">&#39;cidr&#39;</span><span class="p">:</span> <span class="n">msgconf</span><span class="p">[</span><span class="s">&#39;cidr&#39;</span><span class="p">]}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">EXTERNAL_MGMT_PORTS</span><span class="p">]</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg_controller</span><span class="o">.</span><span class="n">create_or_ensure_exists_log_resources</span><span class="p">(</span>
            <span class="n">msgconf</span><span class="p">,</span>
            <span class="n">msgconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">resources</span><span class="p">,</span>
            <span class="s">&#39;management_security_group&#39;</span><span class="p">,</span>
            <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;Cosmo Manager&#39;</span><span class="p">,</span>
            <span class="n">sg_rules</span><span class="p">)</span>

        <span class="c"># Add rules to agent security group. (Happens here because we need</span>
        <span class="c"># the management security group id)</span>
        <span class="k">if</span> <span class="n">agent_sg_created</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sg_controller</span><span class="o">.</span><span class="n">add_rules</span><span class="p">(</span><span class="n">asg_id</span><span class="p">,</span>
                                         <span class="p">[{</span><span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s">&#39;group_id&#39;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">}</span>
                                          <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">INTERNAL_AGENT_PORTS</span><span class="p">])</span>

        <span class="c"># Keypairs setup</span>
        <span class="n">mgr_kpconf</span> <span class="o">=</span> <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">][</span><span class="s">&#39;management_keypair&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keypair_controller</span><span class="o">.</span><span class="n">create_or_ensure_exists_log_resources</span><span class="p">(</span>
            <span class="n">mgr_kpconf</span><span class="p">,</span>
            <span class="n">mgr_kpconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">resources</span><span class="p">,</span>
            <span class="s">&#39;management_keypair&#39;</span><span class="p">,</span>
            <span class="bp">False</span><span class="p">,</span>
            <span class="n">private_key_target_path</span><span class="o">=</span><span class="n">mgr_kpconf</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">]</span>
                                              <span class="p">[</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">]</span> <span class="k">if</span>
            <span class="s">&#39;auto_generated&#39;</span> <span class="ow">in</span> <span class="n">mgr_kpconf</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">public_key_filepath</span><span class="o">=</span><span class="n">mgr_kpconf</span><span class="p">[</span><span class="s">&#39;provided&#39;</span><span class="p">]</span>
                                          <span class="p">[</span><span class="s">&#39;public_key_filepath&#39;</span><span class="p">]</span> <span class="k">if</span>
            <span class="s">&#39;provided&#39;</span> <span class="ow">in</span> <span class="n">mgr_kpconf</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="p">)</span>

        <span class="n">agents_kpconf</span> <span class="o">=</span> <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;agent_servers&#39;</span><span class="p">][</span><span class="s">&#39;agents_keypair&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keypair_controller</span><span class="o">.</span><span class="n">create_or_ensure_exists_log_resources</span><span class="p">(</span>
            <span class="n">agents_kpconf</span><span class="p">,</span>
            <span class="n">agents_kpconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">resources</span><span class="p">,</span>
            <span class="s">&#39;agents_keypair&#39;</span><span class="p">,</span>
            <span class="bp">False</span><span class="p">,</span>
            <span class="n">private_key_target_path</span><span class="o">=</span><span class="n">agents_kpconf</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">]</span>
            <span class="p">[</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s">&#39;auto_generated&#39;</span> <span class="ow">in</span>
                                           <span class="n">agents_kpconf</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">public_key_filepath</span><span class="o">=</span><span class="n">agents_kpconf</span><span class="p">[</span><span class="s">&#39;provided&#39;</span><span class="p">]</span>
                                             <span class="p">[</span><span class="s">&#39;public_key_filepath&#39;</span><span class="p">]</span> <span class="k">if</span>
            <span class="s">&#39;provided&#39;</span> <span class="ow">in</span> <span class="n">agents_kpconf</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="p">)</span>

        <span class="n">server_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_controller</span><span class="o">.</span>\
            <span class="n">create_or_ensure_exists_log_resources</span><span class="p">(</span>
                <span class="n">insconf</span><span class="p">,</span>
                <span class="n">insconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">resources</span><span class="p">,</span>
                <span class="s">&#39;management_server&#39;</span><span class="p">,</span>
                <span class="bp">False</span><span class="p">,</span>
                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">insconf</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">CREATE_IF_MISSING</span><span class="p">},</span>  <span class="c"># NOQA</span>
                <span class="n">mgr_kpconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">msg_id</span> <span class="k">if</span> <span class="n">is_neutron_supported_region</span> <span class="k">else</span> <span class="n">msgconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_neutron_supported_region</span><span class="p">:</span>
            <span class="n">network_name</span> <span class="o">=</span> <span class="n">nconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">insconf</span><span class="p">[</span><span class="n">CREATE_IF_MISSING</span><span class="p">]:</span>  <span class="c"># new server</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attach_floating_ip</span><span class="p">(</span>
                    <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">],</span> <span class="n">enet_id</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span>
                    <span class="n">resources</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c"># existing server</span>
                <span class="n">ips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_controller</span><span class="o">.</span><span class="n">get_server_ips_in_network</span><span class="p">(</span>
                    <span class="n">server_id</span><span class="p">,</span> <span class="n">nconf</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_attach_floating_ip</span><span class="p">(</span>
                        <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">],</span> <span class="n">enet_id</span><span class="p">,</span>
                        <span class="n">server_id</span><span class="p">,</span> <span class="n">resources</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">network_name</span> <span class="o">=</span> <span class="s">&#39;private&#39;</span>

        <span class="n">ips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_controller</span><span class="o">.</span><span class="n">get_server_ips_in_network</span><span class="p">(</span><span class="n">server_id</span><span class="p">,</span>
                                                               <span class="n">network_name</span><span class="p">)</span>
        <span class="n">private_ip</span><span class="p">,</span> <span class="n">public_ip</span> <span class="o">=</span> <span class="n">ips</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ssh_key</span> <span class="o">=</span> <span class="n">mgr_kpconf</span><span class="p">[</span><span class="s">&#39;auto_generated&#39;</span><span class="p">][</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="s">&#39;auto_generated&#39;</span> <span class="ow">in</span> <span class="n">mgr_kpconf</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">ssh_user</span> <span class="o">=</span> <span class="n">compute_config</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">][</span><span class="s">&#39;user_on_management&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">public_ip</span><span class="p">,</span> <span class="n">private_ip</span><span class="p">,</span> <span class="n">ssh_key</span><span class="p">,</span> <span class="n">ssh_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_context</span>
</div>
    <span class="k">def</span> <span class="nf">_check_and_handle_delete_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">all_conflicts</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">check_for_conflicts</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">resource_data</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span>
            <span class="n">conflicts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">resource_data</span><span class="p">[</span><span class="s">&#39;created&#39;</span><span class="p">]:</span>
                <span class="n">conflicts</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">check_for_delete_conflicts</span><span class="p">(</span>
                    <span class="n">resource_data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">all_conflicts</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">conflicts</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_known_resource_id</span><span class="p">(</span><span class="n">resource_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">resources</span><span class="p">[</span><span class="n">resource_name</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span>

        <span class="n">check_for_conflicts</span><span class="p">(</span><span class="s">&#39;floating_ip&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">floating_ip_controller</span><span class="p">)</span>
        <span class="n">check_for_conflicts</span><span class="p">(</span><span class="s">&#39;management_server&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_controller</span><span class="p">)</span>
        <span class="n">check_for_conflicts</span><span class="p">(</span><span class="s">&#39;agents_keypair&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypair_controller</span><span class="p">)</span>
        <span class="n">check_for_conflicts</span><span class="p">(</span><span class="s">&#39;management_keypair&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypair_controller</span><span class="p">)</span>

        <span class="n">known_server_id</span> <span class="o">=</span> <span class="n">get_known_resource_id</span><span class="p">(</span><span class="s">&#39;management_server&#39;</span><span class="p">)</span>
        <span class="n">check_for_conflicts</span><span class="p">(</span><span class="s">&#39;management_security_group&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg_controller</span><span class="p">,</span>
                            <span class="n">servers_for_deletion</span><span class="o">=</span><span class="p">{</span><span class="n">known_server_id</span><span class="p">})</span>
        <span class="n">check_for_conflicts</span><span class="p">(</span><span class="s">&#39;agents_security_group&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg_controller</span><span class="p">,</span>
                            <span class="n">servers_for_deletion</span><span class="o">=</span><span class="p">{</span><span class="n">known_server_id</span><span class="p">})</span>

        <span class="n">known_floating_ip_id</span> <span class="o">=</span> <span class="n">get_known_resource_id</span><span class="p">(</span><span class="s">&#39;floating_ip&#39;</span><span class="p">)</span>
        <span class="n">check_for_conflicts</span><span class="p">(</span><span class="s">&#39;router&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">router_controller</span><span class="p">,</span>
                            <span class="n">floating_ips_for_deletion</span><span class="o">=</span><span class="p">{</span><span class="n">known_floating_ip_id</span><span class="p">})</span>

        <span class="c"># Skipping ext_network - currently not automatically created/deleted.</span>

        <span class="n">known_router_id</span> <span class="o">=</span> <span class="n">get_known_resource_id</span><span class="p">(</span><span class="s">&#39;router&#39;</span><span class="p">)</span>
        <span class="n">check_for_conflicts</span><span class="p">(</span><span class="s">&#39;subnet&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subnet_controller</span><span class="p">,</span>
                            <span class="n">servers_for_deletion</span><span class="o">=</span><span class="p">{</span><span class="n">known_server_id</span><span class="p">},</span>
                            <span class="n">routers_for_deletion</span><span class="o">=</span><span class="p">{</span><span class="n">known_router_id</span><span class="p">})</span>

        <span class="n">known_subnet_id</span> <span class="o">=</span> <span class="n">get_known_resource_id</span><span class="p">(</span><span class="s">&#39;subnet&#39;</span><span class="p">)</span>
        <span class="n">check_for_conflicts</span><span class="p">(</span><span class="s">&#39;int_network&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_controller</span><span class="p">,</span>
                            <span class="n">subnets_for_deletion</span><span class="o">=</span><span class="p">{</span><span class="n">known_subnet_id</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_conflicts_on_known_resources</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="n">all_conflicts</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">format_conflict_print</span><span class="p">(</span><span class="n">conflicted_resource_name</span><span class="p">,</span>
                                  <span class="n">conflicts</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">{0}:</span><span class="se">\n</span><span class="s">&#39;</span>\
                   <span class="s">&#39;</span><span class="se">\t\t</span><span class="s">{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="n">_format_resource_name</span><span class="p">(</span>
                           <span class="n">resources</span><span class="p">[</span><span class="n">conflicted_resource_name</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span>
                           <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">[</span><span class="n">conflicted_resource_name</span><span class="p">]</span> <span class="k">else</span>
                           <span class="n">resources</span><span class="p">[</span><span class="n">conflicted_resource_name</span><span class="p">][</span><span class="s">&#39;ip&#39;</span><span class="p">],</span>
                           <span class="n">resources</span><span class="p">[</span><span class="n">conflicted_resource_name</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">],</span>
                           <span class="n">resources</span><span class="p">[</span><span class="n">conflicted_resource_name</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]),</span>
                       <span class="s">&#39;</span><span class="se">\t\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;{0}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                           <span class="n">_format_resource_name</span><span class="p">(</span><span class="n">conflict_type</span><span class="p">,</span>
                                                 <span class="n">conflict_id</span><span class="p">))</span> <span class="k">for</span>
                                    <span class="n">conflict_type</span><span class="p">,</span> <span class="n">conflict_id</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">]))</span>

        <span class="n">formatted_conflict_lines_str</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">format_conflict_print</span><span class="p">(</span><span class="n">conflicted_resource_name</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">conflicted_resource_name</span><span class="p">,</span> <span class="n">conflicts</span> <span class="ow">in</span> <span class="n">all_conflicts</span>
                <span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">all_conflicts</span><span class="p">[</span><span class="n">conflicted_resource_name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">formatted_conflict_lines_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Conflicts detected:</span><span class="se">\n</span><span class="s">&#39;</span>
                     <span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">formatted_conflict_lines_str</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_propagate_conflicts_on_known_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span>
                                                <span class="n">all_conflicts</span><span class="p">):</span>
        <span class="c"># Propagate conflicts to make sure the conflicts output includes</span>
        <span class="c"># all resources which can&#39;t be taken down - in this case, due to</span>
        <span class="c"># their dependency on other resources which are known but have</span>
        <span class="c"># conflicts themselves.</span>
        <span class="c"># Note that the propagation here is parallel to the</span>
        <span class="c"># &#39;known_&lt;resource&gt;&#39; usage when checking for conflicts, and the</span>
        <span class="c"># order of the propagation is the same as the order for checking</span>
        <span class="c"># conflicts.</span>
        <span class="k">if</span> <span class="n">resources</span><span class="p">[</span><span class="s">&#39;management_security_group&#39;</span><span class="p">][</span><span class="s">&#39;created&#39;</span><span class="p">]:</span>
            <span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;management_security_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">resources</span><span class="p">[</span><span class="s">&#39;agents_security_group&#39;</span><span class="p">][</span><span class="s">&#39;created&#39;</span><span class="p">]:</span>
            <span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;agents_security_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">resources</span><span class="p">[</span><span class="s">&#39;subnet&#39;</span><span class="p">][</span><span class="s">&#39;created&#39;</span><span class="p">]:</span>
            <span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;subnet&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;management_server&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">resources</span><span class="p">[</span><span class="s">&#39;router&#39;</span><span class="p">][</span><span class="s">&#39;created&#39;</span><span class="p">]:</span>
            <span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;router&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;floating_ip&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">resources</span><span class="p">[</span><span class="s">&#39;subnet&#39;</span><span class="p">][</span><span class="s">&#39;created&#39;</span><span class="p">]:</span>
            <span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;subnet&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;router&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">resources</span><span class="p">[</span><span class="s">&#39;int_network&#39;</span><span class="p">][</span><span class="s">&#39;created&#39;</span><span class="p">]:</span>
            <span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;int_network&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">all_conflicts</span><span class="p">[</span><span class="s">&#39;subnet&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_delete_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">deleted_resources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">not_found_resources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failed_to_delete_resources</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">del_resource</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">controller</span><span class="p">):</span>
            <span class="n">resource_data</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">resource_data</span><span class="p">[</span><span class="s">&#39;created&#39;</span><span class="p">]:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">delete_resource</span><span class="p">(</span><span class="n">resource_data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">failed_to_delete_resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">deleted_resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">not_found_resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource_data</span><span class="p">)</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">resources</span><span class="p">[</span><span class="n">resource_name</span><span class="p">])</span>

        <span class="c"># deleting in reversed order to creation order</span>
        <span class="n">del_resource</span><span class="p">(</span><span class="s">&#39;floating_ip&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">floating_ip_controller</span><span class="p">)</span>
        <span class="n">del_resource</span><span class="p">(</span><span class="s">&#39;management_server&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_controller</span><span class="p">)</span>
        <span class="n">del_resource</span><span class="p">(</span><span class="s">&#39;agents_keypair&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypair_controller</span><span class="p">)</span>
        <span class="n">del_resource</span><span class="p">(</span><span class="s">&#39;management_keypair&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypair_controller</span><span class="p">)</span>
        <span class="n">del_resource</span><span class="p">(</span><span class="s">&#39;management_security_group&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg_controller</span><span class="p">)</span>
        <span class="n">del_resource</span><span class="p">(</span><span class="s">&#39;agents_security_group&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg_controller</span><span class="p">)</span>
        <span class="n">del_resource</span><span class="p">(</span><span class="s">&#39;router&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">router_controller</span><span class="p">)</span>
        <span class="c"># Skipping ext_network - currently not automatically created/deleted.</span>
        <span class="n">del_resource</span><span class="p">(</span><span class="s">&#39;subnet&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subnet_controller</span><span class="p">)</span>
        <span class="n">del_resource</span><span class="p">(</span><span class="s">&#39;int_network&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_controller</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">deleted_resources</span><span class="p">,</span> <span class="n">not_found_resources</span><span class="p">,</span>
                <span class="n">failed_to_delete_resources</span><span class="p">)</span>

<div class="viewcode-block" id="CosmoOnOpenStackDriver.delete_topology"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.CosmoOnOpenStackDriver.delete_topology">[docs]</a>    <span class="k">def</span> <span class="nf">delete_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_validation</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_context</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">]</span>

        <span class="n">has_conflicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_handle_delete_conflicts</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_conflicts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_validation</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Not going forward with teardown due to &#39;</span>
                     <span class="s">&#39;validation conflicts.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">deleted_resources</span><span class="p">,</span> <span class="n">not_found_resources</span><span class="p">,</span> <span class="n">failed_to_delete_resources</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete_resources</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">format_resources_data_for_print</span><span class="p">(</span><span class="n">resources_data</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;{0}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_format_resource_name</span><span class="p">(</span>
                    <span class="n">resource_data</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">resource_data</span> <span class="k">else</span>
                    <span class="n">resource_data</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">],</span>
                    <span class="n">resource_data</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">],</span>
                    <span class="n">resource_data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">resource_data</span> <span class="ow">in</span> <span class="n">resources_data</span><span class="p">])</span>

        <span class="n">deleted_resources_print</span> <span class="o">=</span> \
            <span class="s">&#39;Successfully deleted the following resources:</span><span class="se">\n\t</span><span class="s">{0}</span><span class="se">\n</span><span class="s">&#39;</span> \
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format_resources_data_for_print</span><span class="p">(</span><span class="n">deleted_resources</span><span class="p">))</span>
        <span class="n">not_found_resources_print</span> <span class="o">=</span> \
            <span class="s">&quot;The following resources weren&#39;t found:</span><span class="se">\n\t</span><span class="s">{0}</span><span class="se">\n</span><span class="s">&quot;</span> \
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format_resources_data_for_print</span><span class="p">(</span><span class="n">not_found_resources</span><span class="p">))</span>
        <span class="n">failed_to_delete_resources_print</span> <span class="o">=</span> \
            <span class="s">&#39;Failed to delete the following resources:</span><span class="se">\n\t</span><span class="s">{0}&#39;</span> \
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format_resources_data_for_print</span><span class="p">(</span>
                <span class="n">failed_to_delete_resources</span><span class="p">))</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s">&#39;Finished deleting topology;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="s">&#39;{0}{1}{2}&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">deleted_resources_print</span> <span class="k">if</span> <span class="n">deleted_resources</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="n">not_found_resources_print</span> <span class="k">if</span> <span class="n">not_found_resources</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="n">failed_to_delete_resources_print</span> <span class="k">if</span>
                <span class="n">failed_to_delete_resources</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_attach_floating_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mgmt_server_conf</span><span class="p">,</span> <span class="n">enet_id</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span>
                            <span class="n">resources</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;floating_ip&#39;</span> <span class="ow">in</span> <span class="n">mgmt_server_conf</span><span class="p">:</span>
            <span class="n">floating_ip</span> <span class="o">=</span> <span class="n">mgmt_server_conf</span><span class="p">[</span><span class="s">&#39;floating_ip&#39;</span><span class="p">]</span>
            <span class="n">floating_ip_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">floating_ip_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">floating_ip_controller</span><span class="o">.</span><span class="n">allocate_ip</span><span class="p">(</span><span class="n">enet_id</span><span class="p">)</span>
            <span class="n">floating_ip</span> <span class="o">=</span> <span class="n">floating_ip_obj</span><span class="p">[</span><span class="s">&#39;floatingip&#39;</span><span class="p">][</span><span class="s">&#39;floating_ip_address&#39;</span><span class="p">]</span>
            <span class="n">floating_ip_id</span> <span class="o">=</span> <span class="n">floating_ip_obj</span><span class="p">[</span><span class="s">&#39;floatingip&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span>

        <span class="n">resources</span><span class="p">[</span><span class="s">&#39;floating_ip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">floating_ip_id</span><span class="p">),</span>
            <span class="s">&#39;ip&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">floating_ip</span><span class="p">),</span>
            <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;floating ip&#39;</span><span class="p">,</span>
            <span class="s">&#39;created&#39;</span><span class="p">:</span> <span class="s">&#39;floating_ip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mgmt_server_conf</span>
        <span class="p">}</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;attaching IP {0} to the instance&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">floating_ip</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_controller</span><span class="o">.</span><span class="n">add_floating_ip</span><span class="p">(</span><span class="n">server_id</span><span class="p">,</span> <span class="n">floating_ip</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">floating_ip</span>

</div>
<div class="viewcode-block" id="OpenStackLogicError"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackLogicError">[docs]</a><span class="k">class</span> <span class="nc">OpenStackLogicError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="BaseController"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.BaseController">[docs]</a><span class="k">class</span> <span class="nc">BaseController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Will create {0} &#39;{1}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Checking to see if {0} &#39;{1}&#39; already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_objects_with_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;{0} &#39;{1}&#39; already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;{0} &#39;{1}&#39; does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>

<div class="viewcode-block" id="BaseController.create_or_ensure_exists_log_resources"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.BaseController.create_or_ensure_exists_log_resources">[docs]</a>    <span class="k">def</span> <span class="nf">create_or_ensure_exists_log_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                              <span class="n">resources</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span>
                                              <span class="n">return_created</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">id</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_or_ensure_exists</span><span class="p">(</span><span class="n">provider_config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                                    <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">resources</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span>
            <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s">&#39;created&#39;</span><span class="p">:</span> <span class="n">created</span>
        <span class="p">}</span>
        <span class="c"># TODO:</span>
        <span class="c"># replace:</span>
        <span class="k">if</span> <span class="n">return_created</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">id</span><span class="p">,</span> <span class="n">created</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">id</span>
        <span class="c"># with:</span>
        <span class="c"># return id, created if return_created else id</span>
</div>
<div class="viewcode-block" id="BaseController.delete_resource"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.BaseController.delete_resource">[docs]</a>    <span class="k">def</span> <span class="nf">delete_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sleep</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="c"># Attempts to delete a resource by id (with retries).</span>
        <span class="c"># Returns True if resource deleted successfully,</span>
        <span class="c"># False if resource didn&#39;t exist,</span>
        <span class="c"># None if failed to delete existing resource</span>
        <span class="n">res_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Attempting to delete resource {0}&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_format_resource_name</span><span class="p">(</span><span class="n">res_type</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">retry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c"># Checking if resource doesn&#39;t exist</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_openstack_404_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;resource {0} wasn&#39;t found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource_id</span><span class="p">))</span>
                    <span class="k">return</span> <span class="bp">False</span>

                <span class="c"># Different error occurred. Retry or give up.</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Error while attempting to delete resource &quot;</span>
                          <span class="s">&quot;{0} [retry {1} of {2}]: {3}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">_format_resource_name</span><span class="p">(</span><span class="n">res_type</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">),</span>
                              <span class="n">retry</span><span class="p">,</span> <span class="n">retries</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_resource_to_be_deleted</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;resource {0} terminated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource_id</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Error while waiting for resource {0} &#39;</span>
                          <span class="s">&#39;to terminate: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">_format_resource_name</span><span class="p">(</span><span class="n">res_type</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">),</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Failed all retries to delete resource {0}&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_format_resource_name</span><span class="p">(</span><span class="n">res_type</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">)))</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">_wait_for_resource_to_be_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">):</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;resource {0} is still up&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_openstack_404_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="k">return</span>
                <span class="k">raise</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;resource {0} failed to terminate in time&#39;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource_id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_is_openstack_404_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="c"># It seems like at the moment, exceptions from Neutron for example</span>
        <span class="c"># are general &quot;NeutronError&quot; exceptions rather than a clean</span>
        <span class="c"># neutronclient.common.exceptions.NotFound error, which is</span>
        <span class="c"># why we check for the status code instead.</span>
        <span class="c"># nova in different regions and neutron may use either status_code</span>
        <span class="c"># or http_status fields.</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&#39;status_code&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span> <span class="ow">or</span> \
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&#39;http_status&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">http_status</span> <span class="o">==</span> <span class="mi">404</span>

    <span class="k">def</span> <span class="nf">_create_or_ensure_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if resource exists:</span>
<span class="sd">            if resource is server:</span>
<span class="sd">                raise already exists</span>
<span class="sd">            use resource</span>
<span class="sd">        else:</span>
<span class="sd">            if not create_if_missing:</span>
<span class="sd">                raise does not exist</span>
<span class="sd">            create resource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;server&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">OpenStackLogicError</span><span class="p">(</span><span class="s">&quot;{0} &#39;{1}&#39; already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="n">the_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_exists</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">created</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">CREATE_IF_MISSING</span> <span class="ow">in</span> <span class="n">provider_config</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">provider_config</span><span class="p">[</span><span class="n">CREATE_IF_MISSING</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">OpenStackLogicError</span><span class="p">(</span><span class="s">&quot;{0} &#39;{1}&#39; is not configured to&quot;</span>
                                          <span class="s">&quot; create_if_missing but but does not&quot;</span>
                                          <span class="s">&quot; exist.&quot;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="n">the_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">created</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">the_id</span><span class="p">,</span> <span class="n">created</span>

<div class="viewcode-block" id="BaseController.ensure_exists"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.BaseController.ensure_exists">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Will use existing {0} &#39;{1}&#39;&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OpenStackLogicError</span><span class="p">(</span><span class="s">&quot;{0} &#39;{1}&#39; was not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="BaseController.find_by_name"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.BaseController.find_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">find_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_objects_with_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">OpenStackLogicError</span><span class="p">(</span><span class="s">&quot;Lookup of {0} named &#39;{1}&#39; failed. There &quot;</span>
                                  <span class="s">&quot;are {2} matches.&quot;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)))</span>
</div>
    <span class="k">def</span> <span class="nf">_fail_on_missing_required_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">required_parameters</span><span class="p">,</span>
                                             <span class="n">hint_where</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required_parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OpenStackLogicError</span><span class="p">(</span><span class="s">&quot;Required parameter &#39;{0}&#39; is &quot;</span>
                                          <span class="s">&quot;missing (under {3}&#39;s properties.&quot;</span>
                                          <span class="s">&quot;{1}). &quot;</span>
                                          <span class="s">&quot;Required parameters are: {2}&quot;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">hint_where</span><span class="p">,</span>
                                                  <span class="n">required_parameters</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">WHAT</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="BaseControllerNova"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.BaseControllerNova">[docs]</a><span class="k">class</span> <span class="nc">BaseControllerNova</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">):</span>
        <span class="n">BaseController</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">get_nova_client</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="BaseControllerNeutron"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.BaseControllerNeutron">[docs]</a><span class="k">class</span> <span class="nc">BaseControllerNeutron</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">):</span>
        <span class="n">BaseController</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">get_neutron_client</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="OpenStackNetworkController"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNetworkController">[docs]</a><span class="k">class</span> <span class="nc">OpenStackNetworkController</span><span class="p">(</span><span class="n">BaseControllerNeutron</span><span class="p">):</span>
    <span class="n">WHAT</span> <span class="o">=</span> <span class="s">&#39;network&#39;</span>

<div class="viewcode-block" id="OpenStackNetworkController.list_objects_with_name"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNetworkController.list_objects_with_name">[docs]</a>    <span class="k">def</span> <span class="nf">list_objects_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">list_networks</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)[</span><span class="s">&#39;networks&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackNetworkController.create"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNetworkController.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;network&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s">&#39;admin_state_up&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">ext</span><span class="p">:</span>
            <span class="n">n</span><span class="p">[</span><span class="s">&#39;router:external&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">create_network</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="s">&#39;network&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackNetworkController.get_by_id"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNetworkController.get_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">show_network</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackNetworkController.check_for_delete_conflicts"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNetworkController.check_for_delete_conflicts">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_delete_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># checking for collisions with unknown subnets</span>
        <span class="c"># Notes:</span>
        <span class="c"># 1) No check for unknown servers on the known subnets is made,</span>
        <span class="c"># as it is expected for those subnets to be go through deletion</span>
        <span class="c"># before the network does. Same goes for routers and router ports</span>
        <span class="c"># (also note that it&#39;s impossible to connect a network without</span>
        <span class="c"># subnets can&#39;t to a router port).</span>
        <span class="c"># 2) While it is possible to connect a server &#39;directly&#39; to a</span>
        <span class="c"># network (i.e. a subnet-less network), there&#39;s no need to check for</span>
        <span class="c"># server conflicts as such a network can be deleted regardless of</span>
        <span class="c"># such servers, with no effect on the servers.</span>
        <span class="c"># 3) On the other hand, while Openstack does allow for network</span>
        <span class="c"># deletion without deleting its subnets beforehand, this in practice</span>
        <span class="c">#  also deletes the underlying subnets - and therefore we do have to</span>
        <span class="c">#  check for subnet conflicts.</span>

        <span class="n">subnets_for_deletion</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subnets_for_deletion&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">subnet_conflicts</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;subnet&#39;</span><span class="p">,</span> <span class="n">subnet</span><span class="p">)</span> <span class="k">for</span> <span class="n">subnet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span>
            <span class="n">network_id</span><span class="p">)[</span><span class="s">&#39;network&#39;</span><span class="p">][</span><span class="s">&#39;subnets&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">subnet</span>
            <span class="ow">not</span> <span class="ow">in</span> <span class="n">subnets_for_deletion</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">subnet_conflicts</span>
</div>
<div class="viewcode-block" id="OpenStackNetworkController.delete"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNetworkController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">delete_network</span><span class="p">(</span><span class="n">network_id</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OpenStackSubnetController"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackSubnetController">[docs]</a><span class="k">class</span> <span class="nc">OpenStackSubnetController</span><span class="p">(</span><span class="n">BaseControllerNeutron</span><span class="p">):</span>
    <span class="n">WHAT</span> <span class="o">=</span> <span class="s">&#39;subnet&#39;</span>

<div class="viewcode-block" id="OpenStackSubnetController.list_objects_with_name"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackSubnetController.list_objects_with_name">[docs]</a>    <span class="k">def</span> <span class="nf">list_objects_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">list_subnets</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)[</span><span class="s">&#39;subnets&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackSubnetController.create"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackSubnetController.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="n">cidr</span><span class="p">,</span> <span class="n">dns_nameservers</span><span class="p">,</span> <span class="n">net_id</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">create_subnet</span><span class="p">({</span>
            <span class="s">&#39;subnet&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s">&#39;ip_version&#39;</span><span class="p">:</span> <span class="n">ip_version</span><span class="p">,</span>
                <span class="s">&#39;cidr&#39;</span><span class="p">:</span> <span class="n">cidr</span><span class="p">,</span>
                <span class="s">&#39;dns_nameservers&#39;</span><span class="p">:</span> <span class="n">dns_nameservers</span><span class="p">,</span>
                <span class="s">&#39;network_id&#39;</span><span class="p">:</span> <span class="n">net_id</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="s">&#39;subnet&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackSubnetController.get_by_id"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackSubnetController.get_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">show_subnet</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackSubnetController.check_for_delete_conflicts"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackSubnetController.check_for_delete_conflicts">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_delete_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subnet_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># checking for collisions with unknown servers and routers</span>
        <span class="n">servers_for_deletion</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;servers_for_deletion&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">routers_for_deletion</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;routers_for_deletion&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">router_conflicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">server_conflicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">list_ports</span><span class="p">()[</span><span class="s">&#39;ports&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
            <span class="c"># for each port, check if it has an ip on the given subnet,</span>
            <span class="c"># if it belongs to a server or a router (and not, for example,</span>
            <span class="c"># a DHCP port), and if that device is up for deletion or not</span>
            <span class="k">if</span> <span class="s">&#39;device_owner&#39;</span> <span class="ow">in</span> <span class="n">port</span> <span class="ow">and</span> \
                <span class="nb">len</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s">&#39;fixed_ips&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> \
                <span class="p">((</span><span class="n">port</span><span class="p">[</span><span class="s">&#39;device_owner&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;network:router_interface&#39;</span> <span class="ow">and</span>
                  <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">routers_for_deletion</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s">&#39;device_owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;compute&#39;</span><span class="p">)</span> <span class="ow">and</span>
                  <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">servers_for_deletion</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">fixed_ip</span> <span class="ow">in</span> <span class="n">port</span><span class="p">[</span><span class="s">&#39;fixed_ips&#39;</span><span class="p">]:</span>
                    <span class="c"># should be only one, but iterating over it anyway.</span>
                    <span class="k">if</span> <span class="s">&#39;subnet_id&#39;</span> <span class="ow">in</span> <span class="n">fixed_ip</span> <span class="ow">and</span> <span class="n">fixed_ip</span><span class="p">[</span><span class="s">&#39;subnet_id&#39;</span><span class="p">]</span> <span class="o">==</span> \
                            <span class="n">subnet_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_owner&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;network:router_interface&#39;</span><span class="p">:</span>
                            <span class="n">router_conflicts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;router&#39;</span><span class="p">,</span>
                                                     <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_id&#39;</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">server_conflicts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;server&#39;</span><span class="p">,</span>
                                                    <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_id&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">server_conflicts</span> <span class="o">+</span> <span class="n">router_conflicts</span>
</div>
<div class="viewcode-block" id="OpenStackSubnetController.delete"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackSubnetController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subnet_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">delete_subnet</span><span class="p">(</span><span class="n">subnet_id</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OpenStackFloatingIpController"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackFloatingIpController">[docs]</a><span class="k">class</span> <span class="nc">OpenStackFloatingIpController</span><span class="p">(</span><span class="n">BaseControllerNeutron</span><span class="p">):</span>
    <span class="n">WHAT</span> <span class="o">=</span> <span class="s">&#39;floating_ip&#39;</span>

<div class="viewcode-block" id="OpenStackFloatingIpController.list_objects_with_name"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackFloatingIpController.list_objects_with_name">[docs]</a>    <span class="k">def</span> <span class="nf">list_objects_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;UNSUPPORTED OPERATION&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackFloatingIpController.create"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackFloatingIpController.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;UNSUPPORTED OPERATION&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackFloatingIpController.allocate_ip"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackFloatingIpController.allocate_ip">[docs]</a>    <span class="k">def</span> <span class="nf">allocate_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_network_id</span><span class="p">):</span>
        <span class="n">floating_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">create_floatingip</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s">&quot;floatingip&quot;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s">&quot;floating_network_id&quot;</span><span class="p">:</span> <span class="n">external_network_id</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">floating_ip</span>
</div>
<div class="viewcode-block" id="OpenStackFloatingIpController.get_by_id"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackFloatingIpController.get_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">show_floatingip</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackFloatingIpController.check_for_delete_conflicts"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackFloatingIpController.check_for_delete_conflicts">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_delete_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">floating_ip_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="OpenStackFloatingIpController.delete"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackFloatingIpController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">floating_ip_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">delete_floatingip</span><span class="p">(</span><span class="n">floating_ip_id</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OpenStackRouterController"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackRouterController">[docs]</a><span class="k">class</span> <span class="nc">OpenStackRouterController</span><span class="p">(</span><span class="n">BaseControllerNeutron</span><span class="p">):</span>
    <span class="n">WHAT</span> <span class="o">=</span> <span class="s">&#39;router&#39;</span>

<div class="viewcode-block" id="OpenStackRouterController.list_objects_with_name"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackRouterController.list_objects_with_name">[docs]</a>    <span class="k">def</span> <span class="nf">list_objects_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">list_routers</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)[</span><span class="s">&#39;routers&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackRouterController.create"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackRouterController.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">interfaces</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">external_gateway_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;router&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s">&#39;admin_state_up&#39;</span><span class="p">:</span> <span class="bp">True</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">external_gateway_info</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s">&#39;router&#39;</span><span class="p">][</span><span class="s">&#39;external_gateway_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_gateway_info</span>
        <span class="n">router_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">create_router</span><span class="p">(</span><span class="n">args</span><span class="p">)[</span><span class="s">&#39;router&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">interfaces</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">add_interface_router</span><span class="p">(</span><span class="n">router_id</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">router_id</span>
</div>
<div class="viewcode-block" id="OpenStackRouterController.get_by_id"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackRouterController.get_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">show_router</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackRouterController.check_for_delete_conflicts"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackRouterController.check_for_delete_conflicts">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_delete_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">router_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># checking for collisions with unknown floating_ips.</span>
        <span class="n">floating_ips_for_deletion</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;floating_ips_for_deletion&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">floating_ips_conflicts</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;floating_ip&#39;</span><span class="p">,</span> <span class="n">floating_ip</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span> <span class="k">for</span>
                                  <span class="n">floating_ip</span> <span class="ow">in</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">list_floatingips</span><span class="p">()[</span>
                                      <span class="s">&#39;floatingips&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">floating_ip</span><span class="p">[</span>
                                      <span class="s">&#39;router_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">router_id</span> <span class="ow">and</span>
                                  <span class="n">floating_ip</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span>
                                  <span class="n">floating_ips_for_deletion</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">floating_ips_conflicts</span>
</div>
<div class="viewcode-block" id="OpenStackRouterController.delete"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackRouterController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">router_id</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">list_ports</span><span class="p">(</span>
                <span class="n">device_id</span><span class="o">=</span><span class="n">router_id</span><span class="p">)[</span><span class="s">&#39;ports&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">port</span><span class="p">[</span><span class="s">&#39;fixed_ips&#39;</span><span class="p">]:</span>
                <span class="c"># should be only one, but iterating over it anyway.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">remove_interface_router</span><span class="p">(</span><span class="n">router_id</span><span class="p">,</span>
                                                            <span class="n">interface</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">delete_router</span><span class="p">(</span><span class="n">router_id</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OpenStackNovaSecurityGroupController"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNovaSecurityGroupController">[docs]</a><span class="k">class</span> <span class="nc">OpenStackNovaSecurityGroupController</span><span class="p">(</span><span class="n">BaseControllerNova</span><span class="p">):</span>
    <span class="n">WHAT</span> <span class="o">=</span> <span class="s">&#39;nova security group&#39;</span>

<div class="viewcode-block" id="OpenStackNovaSecurityGroupController.list_objects_with_name"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNovaSecurityGroupController.list_objects_with_name">[docs]</a>    <span class="k">def</span> <span class="nf">list_objects_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">sgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">security_groups</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">sg</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">sgs</span> <span class="k">if</span> <span class="n">sg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackNovaSecurityGroupController.create"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNovaSecurityGroupController.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">rules</span><span class="p">):</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">security_groups</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">security_group_rules</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">sg</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">ip_protocol</span><span class="o">=</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span>
                <span class="n">from_port</span><span class="o">=</span><span class="n">rule</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span>
                <span class="n">to_port</span><span class="o">=</span><span class="n">rule</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span>
                <span class="n">cidr</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cidr&#39;</span><span class="p">),</span>
                <span class="n">group_id</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;group_id&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">sg</span><span class="o">.</span><span class="n">id</span>
</div>
<div class="viewcode-block" id="OpenStackNovaSecurityGroupController.get_by_id"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNovaSecurityGroupController.get_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">security_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackNovaSecurityGroupController.check_for_delete_conflicts"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNovaSecurityGroupController.check_for_delete_conflicts">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_delete_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># checking for collisions with unknown servers</span>
        <span class="n">servers_for_deletion</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;servers_for_deletion&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">servers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">server_conflicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">server</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">servers_for_deletion</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">security_groups</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sg</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sg_id</span><span class="p">:</span>
                        <span class="n">server_conflicts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;server&#39;</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">server_conflicts</span>
</div>
<div class="viewcode-block" id="OpenStackNovaSecurityGroupController.delete"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNovaSecurityGroupController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">security_groups</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">sg_id</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OpenStackNeutronSecurityGroupController"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNeutronSecurityGroupController">[docs]</a><span class="k">class</span> <span class="nc">OpenStackNeutronSecurityGroupController</span><span class="p">(</span><span class="n">BaseControllerNeutron</span><span class="p">):</span>
    <span class="n">WHAT</span> <span class="o">=</span> <span class="s">&#39;neutron security group&#39;</span>

<div class="viewcode-block" id="OpenStackNeutronSecurityGroupController.list_objects_with_name"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNeutronSecurityGroupController.list_objects_with_name">[docs]</a>    <span class="k">def</span> <span class="nf">list_objects_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">list_security_groups</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)[</span><span class="s">&#39;security_groups&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackNeutronSecurityGroupController.create"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNeutronSecurityGroupController.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">rules</span><span class="p">):</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">create_security_group</span><span class="p">({</span>
            <span class="s">&#39;security_group&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">})[</span><span class="s">&#39;security_group&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_rules</span><span class="p">(</span><span class="n">sg</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">rules</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sg</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackNeutronSecurityGroupController.add_rules"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNeutronSecurityGroupController.add_rules">[docs]</a>    <span class="k">def</span> <span class="nf">add_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_id</span><span class="p">,</span> <span class="n">rules</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">create_security_group_rule</span><span class="p">({</span>
                <span class="s">&#39;security_group_rule&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;security_group_id&#39;</span><span class="p">:</span> <span class="n">sg_id</span><span class="p">,</span>
                    <span class="s">&#39;direction&#39;</span><span class="p">:</span> <span class="s">&#39;ingress&#39;</span><span class="p">,</span>
                    <span class="s">&#39;protocol&#39;</span><span class="p">:</span> <span class="s">&#39;tcp&#39;</span><span class="p">,</span>
                    <span class="s">&#39;port_range_min&#39;</span><span class="p">:</span> <span class="n">rule</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span>
                    <span class="s">&#39;port_range_max&#39;</span><span class="p">:</span> <span class="n">rule</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span>
                    <span class="s">&#39;remote_ip_prefix&#39;</span><span class="p">:</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cidr&#39;</span><span class="p">),</span>
                    <span class="s">&#39;remote_group_id&#39;</span><span class="p">:</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;group_id&#39;</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">})</span>
</div>
<div class="viewcode-block" id="OpenStackNeutronSecurityGroupController.get_by_id"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNeutronSecurityGroupController.get_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">show_security_group</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackNeutronSecurityGroupController.check_for_delete_conflicts"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNeutronSecurityGroupController.check_for_delete_conflicts">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_delete_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># checking for collisions with unknown servers and routers.</span>
        <span class="c"># note that there&#39;s no &#39;routers_for_deletion&#39; parameter, as we don&#39;t</span>
        <span class="c"># link between any security group and a router port on bootstrap,</span>
        <span class="c"># so any linked port is in fact a conflict.</span>
        <span class="n">servers_for_deletion</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;servers_for_deletion&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">server_conflicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">router_conflicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">list_ports</span><span class="p">()[</span><span class="s">&#39;ports&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">sg_id</span> <span class="ow">in</span> <span class="n">port</span><span class="p">[</span><span class="s">&#39;security_groups&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_owner&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;network:router_interface&#39;</span><span class="p">:</span>
                    <span class="n">router_conflicts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;router&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_id&#39;</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;compute&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">servers_for_deletion</span><span class="p">:</span>
                    <span class="n">server_conflicts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;server&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s">&#39;device_id&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">server_conflicts</span> <span class="o">+</span> <span class="n">router_conflicts</span>
</div>
<div class="viewcode-block" id="OpenStackNeutronSecurityGroupController.delete"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackNeutronSecurityGroupController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">delete_security_group</span><span class="p">(</span><span class="n">sg_id</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OpenStackKeypairController"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackKeypairController">[docs]</a><span class="k">class</span> <span class="nc">OpenStackKeypairController</span><span class="p">(</span><span class="n">BaseControllerNova</span><span class="p">):</span>
    <span class="n">WHAT</span> <span class="o">=</span> <span class="s">&#39;keypair&#39;</span>

<div class="viewcode-block" id="OpenStackKeypairController.list_objects_with_name"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackKeypairController.list_objects_with_name">[docs]</a>    <span class="k">def</span> <span class="nf">list_objects_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">keypairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">keypairs</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">keypair</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="k">for</span> <span class="n">keypair</span> <span class="ow">in</span> <span class="n">keypairs</span> <span class="k">if</span>
                <span class="n">keypair</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackKeypairController.create"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackKeypairController.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_name</span><span class="p">,</span> <span class="n">private_key_target_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">public_key_filepath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">private_key_target_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">public_key_filepath</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Must provide either private key target path &quot;</span>
                               <span class="s">&quot;or public key filepath to create keypair&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">public_key_filepath</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="n">public_key_filepath</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">keypair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">keypairs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">key_name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keypair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">keypairs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">key_name</span><span class="p">)</span>
            <span class="n">pk_target_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">private_key_target_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mkdir_p</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">private_key_target_path</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pk_target_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">keypair</span><span class="o">.</span><span class="n">private_key</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;chmod 600 {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pk_target_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">keypair</span><span class="o">.</span><span class="n">id</span>
</div>
<div class="viewcode-block" id="OpenStackKeypairController.get_by_id"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackKeypairController.get_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">keypairs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_mkdir_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;creating dir {0}&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="OpenStackKeypairController.check_for_delete_conflicts"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackKeypairController.check_for_delete_conflicts">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_delete_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keypair_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Note: While it might be somewhat weird to delete a keypair which is</span>
        <span class="c"># currently in use by a server, Openstack does allow this and thus</span>
        <span class="c"># so do we.</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="OpenStackKeypairController.delete"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackKeypairController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keypair_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">keypairs</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">keypair_id</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OpenStackServerController"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackServerController">[docs]</a><span class="k">class</span> <span class="nc">OpenStackServerController</span><span class="p">(</span><span class="n">BaseControllerNova</span><span class="p">):</span>
    <span class="n">WHAT</span> <span class="o">=</span> <span class="s">&#39;server&#39;</span>

<div class="viewcode-block" id="OpenStackServerController.list_objects_with_name"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackServerController.list_objects_with_name">[docs]</a>    <span class="k">def</span> <span class="nf">list_objects_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">servers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="OpenStackServerController.create"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackServerController.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">server_config</span><span class="p">,</span> <span class="n">management_server_keypair_name</span><span class="p">,</span>
               <span class="n">sgm_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a server. Exposes the parameters mentioned in</span>
<span class="sd">        http://docs.openstack.org/developer/python-novaclient/api/novaclient</span>
<span class="sd">        .v1_1.servers.html#novaclient.v1_1.servers.ServerManager.create</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fail_on_missing_required_parameters</span><span class="p">(</span>
            <span class="n">server_config</span><span class="p">,</span>
            <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;flavor&#39;</span><span class="p">,</span> <span class="s">&#39;image&#39;</span><span class="p">),</span>
            <span class="s">&#39;compute.management_server.instance&#39;</span><span class="p">)</span>

        <span class="c"># First parameter is &#39;self&#39;, skipping</span>
        <span class="n">params_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">create</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">params_default_values</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">create</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">params_names</span><span class="p">,</span> <span class="n">params_default_values</span><span class="p">))</span>

        <span class="c"># Fail on unsupported parameters</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">server_config</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Parameter with name &#39;{0}&#39; must not be passed&quot;</span>
                                 <span class="s">&quot; to openstack provisioner (under &quot;</span>
                                 <span class="s">&quot;compute.management_server.instance)&quot;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">server_config</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">server_name</span> <span class="o">=</span> <span class="n">server_config</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_by_name</span><span class="p">(</span><span class="n">server_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Can not provision the server with name &#39;{0}&#39;&quot;</span>
                               <span class="s">&quot; because server with such name &quot;</span>
                               <span class="s">&quot;already exists&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">server_name</span><span class="p">))</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Asking Nova to create server. Parameters: {0}&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>

        <span class="n">configured_sgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;security_groups&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">configured_sgs</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;security_groups&#39;</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;security_groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sgm_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">configured_sgs</span>

        <span class="n">params</span><span class="p">[</span><span class="s">&#39;key_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">management_server_keypair_name</span>

        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_server_to_become_active</span><span class="p">(</span><span class="n">server_name</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">server</span><span class="o">.</span><span class="n">id</span>
</div>
<div class="viewcode-block" id="OpenStackServerController.add_floating_ip"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackServerController.add_floating_ip">[docs]</a>    <span class="k">def</span> <span class="nf">add_floating_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">ip</span><span class="p">):</span>

        <span class="c"># Extra: detach floating ip from existng server</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">floating_ips</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OpenStackLogicError</span><span class="p">(</span>
                    <span class="s">&quot;Floating IP {0} does not exist so it can &quot;</span>
                    <span class="s">&quot;not be attached to server {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">server_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OpenStackLogicError</span><span class="p">(</span>
                    <span class="s">&quot;Floating IP {0} is attached to &quot;</span>
                    <span class="s">&quot;{1} instances&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">instance_id</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s">&quot;Floating IP {0} is not attached to any instance. &quot;</span>
                    <span class="s">&quot;Continuing.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s">&quot;Floating IP {0} is attached &quot;</span>
                <span class="s">&quot;to instance {1}. Detaching.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">instance_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">remove_floating_ip</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">instance_id</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">server_id</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">add_floating_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackServerController.get_server_ips_in_network"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackServerController.get_server_ips_in_network">[docs]</a>    <span class="k">def</span> <span class="nf">get_server_ips_in_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">network_name</span><span class="p">):</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">server_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">network_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">networks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OpenStackLogicError</span><span class="p">(</span>
                <span class="s">&quot;Server {0} ({1}) does not have address in&quot;</span>
                <span class="s">&quot; network {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">network_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">server</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network_name</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_wait_for_server_to_become_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="k">while</span> <span class="n">server</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s">&quot;ACTIVE&quot;</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">-=</span> <span class="mi">5</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Server failed to start in time&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">server</span>

<div class="viewcode-block" id="OpenStackServerController.get_by_id"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackServerController.get_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenStackServerController.check_for_delete_conflicts"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackServerController.check_for_delete_conflicts">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_delete_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="OpenStackServerController.delete"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackServerController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">server_id</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OpenStackConnector"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackConnector">[docs]</a><span class="k">class</span> <span class="nc">OpenStackConnector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c"># TODO: maybe lazy?</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">provider_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keystone_client</span> <span class="o">=</span> <span class="n">keystone_client</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;keystone&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;neutron_supported_region&#39;</span><span class="p">]:</span>

            <span class="c"># if neutron not explicitly specified, use catalog to locate</span>
            <span class="c"># public URL of &#39;network&#39; service</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modify_neutron_url_from_catalog</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span> <span class="o">=</span> \
                <span class="n">neutron_client</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="s">&#39;2.0&#39;</span><span class="p">,</span>
                                      <span class="n">endpoint_url</span><span class="o">=</span><span class="n">provider_config</span>
                                      <span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">]</span>
                                      <span class="p">[</span><span class="s">&#39;neutron_url&#39;</span><span class="p">],</span>
                                      <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keystone_client</span><span class="o">.</span><span class="n">auth_token</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s">&#39;json&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">kconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;keystone&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span> <span class="o">=</span> <span class="n">nova_client</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
            <span class="n">kconf</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
            <span class="n">kconf</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">],</span>
            <span class="n">kconf</span><span class="p">[</span><span class="s">&#39;tenant_name&#39;</span><span class="p">],</span>
            <span class="n">kconf</span><span class="p">[</span><span class="s">&#39;auth_url&#39;</span><span class="p">],</span>
            <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;compute&#39;</span><span class="p">][</span><span class="s">&#39;region&#39;</span><span class="p">],</span>
            <span class="n">http_log_debug</span><span class="o">=</span><span class="bp">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_modify_neutron_url_from_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If neutron URL is not set or is empty, use the public URL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">neutron_url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;neutron_url&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="c"># neutron service names differ in some installations</span>
            <span class="n">neutron_service_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;network&#39;</span><span class="p">,</span> <span class="s">&#39;neutron&#39;</span><span class="p">]</span>
            <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;compute&#39;</span><span class="p">][</span><span class="s">&#39;region&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">service_name</span> <span class="ow">in</span> <span class="n">neutron_service_names</span><span class="p">:</span>
                <span class="n">neutron_url</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">keystone_client</span><span class="o">.</span><span class="n">service_catalog</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                        <span class="n">service_type</span><span class="o">=</span><span class="n">service_name</span><span class="p">,</span> <span class="n">endpoint_type</span><span class="o">=</span><span class="s">&#39;publicURL&#39;</span><span class="p">,</span>
                        <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">neutron_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">neutron_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;networking&#39;</span><span class="p">][</span><span class="s">&#39;neutron_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutron_url</span>

<div class="viewcode-block" id="OpenStackConnector.get_keystone_client"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackConnector.get_keystone_client">[docs]</a>    <span class="k">def</span> <span class="nf">get_keystone_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keystone_client</span>
</div>
<div class="viewcode-block" id="OpenStackConnector.get_neutron_client"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackConnector.get_neutron_client">[docs]</a>    <span class="k">def</span> <span class="nf">get_neutron_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutron_client</span>
</div>
<div class="viewcode-block" id="OpenStackConnector.get_nova_client"><a class="viewcode-back" href="../../index.html#cloudify_openstack.cloudify_openstack.OpenStackConnector.get_nova_client">[docs]</a>    <span class="k">def</span> <span class="nf">get_nova_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nova_client</span></div></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Gigaspaces.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>